# User Code Key Exchange Protocol

This document describes how the user code is generated and exchanged between the receiver and sender in the SSH Portal system.

## Overview

The SSH Portal uses a two-part secret exchange mechanism:
1. **Relay Code**: Generated by the relay server, used for pairing with the relay
2. **Receiver Code**: Generated locally by the receiver, kept secret from the relay
3. **User Code**: A human-readable encoding of both codes combined, displayed to the user
4. **Full Code**: The base64-encoded combination of both codes, used for SSH authentication

## Protocol Flow

### 1. Receiver Setup

When a receiver starts:

1. **Generate Receiver Code**
   - The receiver generates 32 bits (4 bytes) of cryptographically random entropy
   - Encoded as base64 (raw, no padding)
   - Example: `"AbCdEfGh"` (8 characters, representing 4 bytes)

2. **Connect to Relay**
   - Receiver connects to relay and requests an invite (mint operation)
   - Relay generates a **Relay Code** (32 bits, base64 encoded)
   - Relay returns: `{code: <relayCode>, rid: <rendezvous-id>, exp: <expiry>}`

3. **Generate User Code**
   - Receiver combines relay code (4 bytes) + receiver code (4 bytes) = **full code** (8 bytes)
   - The full code is encoded into a human-readable **user code** format
   - Format: `word-word-word-word-xxx-xxxx`
     - 4 BIP39 English words (from 2048-word list)
     - 7 decimal digits formatted as `xxx-xxxx`
   - Example: `"abandon-ability-able-about-123-4567"`

4. **Display User Code**
   - The receiver displays the user code to the user
   - This is the code the user will share with the sender

5. **SSH Server Configuration**
   - Receiver configures SSH server to expect:
     - **Username**: Relay code (base64, 4 bytes)
     - **Password**: Full code (base64, 8 bytes)

### 2. Sender Connection

When a sender connects:

1. **Receive User Code**
   - User provides the user code from the receiver
   - Example: `"abandon-ability-able-about-123-4567"`

2. **Parse User Code**
   - Sender parses the user code to extract:
     - **Relay code**: First 4 bytes (base64 encoded)
     - **Receiver code**: Last 4 bytes (base64 encoded)
     - **Full code**: All 8 bytes (base64 encoded)

3. **Connect to Relay**
   - Sender sends only the **relay code** to the relay in the hello message
   - Relay matches the code to find the waiting receiver
   - Relay sends "ready" message to receiver
   - Relay sends "ok" response to sender

4. **SSH Authentication**
   - Sender uses:
     - **Username**: Relay code (base64, 4 bytes)
     - **Password**: Full code (base64, 8 bytes)

## Security Properties

1. **Two-Part Secret**
   - The relay only knows the relay code (first 4 bytes)
   - The receiver generates the receiver code locally (last 4 bytes)
   - The relay never sees the receiver code, providing additional security

2. **Forward Secrecy**
   - Each connection uses a unique receiver code
   - Even if the relay code is compromised, the receiver code is still secret

3. **User-Friendly Display**
   - The user code is designed to be easy to read and type
   - Uses BIP39 words for familiarity and error detection
   - Numeric portion provides additional entropy

4. **SSH Authentication**
   - The full code (both parts) is required for SSH authentication
   - The relay code alone is insufficient to authenticate
